<div class="hidden lg:block">
  <h2 class="mb-4 text-xs font-semibold uppercase tracking-widest text-slate-500">On this page</h2>
  <nav id="generated-toc" class="relative border-l border-white/10" aria-label="Table of contents"></nav>
</div>

<script>
  (function () {
    if (window.__blogTocInitialized) return;
    window.__blogTocInitialized = true;

    const article = document.querySelector("[data-article-root]");
    const toc = document.getElementById("generated-toc");

    if (!article || !toc) return;

    const headings = Array.from(article.querySelectorAll("h2, h3"));

    if (!headings.length) {
      toc.innerHTML = '<p class="pl-4 text-xs text-slate-500">No sections available.</p>';
      return;
    }

    const slugify = (text) =>
      text
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s-]/g, "")
        .replace(/\s+/g, "-");

    headings.forEach((heading) => {
      if (!heading.id) {
        heading.id = slugify(heading.textContent || "section");
      }
      heading.classList.add("scroll-mt-32"); // Add scroll margin for sticky header

      const link = document.createElement("a");
      link.href = `#${heading.id}`;
      link.textContent = heading.textContent || heading.id;

      // Base classes for all links
      let className = "block border-l border-transparent -ml-px py-1.5 text-sm transition-colors hover:border-slate-400 hover:text-slate-200";

      // Indentation for H3
      if (heading.tagName === "H3") {
        className += " pl-8 text-slate-500";
      } else {
        className += " pl-4 text-slate-400";
      }

      link.className = className;
      link.dataset.targetId = heading.id;

      toc.appendChild(link);
    });

    // Scroll Spy Implementation
    const observerOptions = {
      root: null,
      rootMargin: "-100px 0px -66%",
      threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const activeId = entry.target.id;
          updateActiveLink(activeId);
        }
      });
    }, observerOptions);

    headings.forEach((heading) => observer.observe(heading));

    function updateActiveLink(id) {
      const links = toc.querySelectorAll("a");
      links.forEach((link) => {
        const isTarget = link.dataset.targetId === id;

        if (isTarget) {
          link.classList.remove("border-transparent", "text-slate-400", "text-slate-500");
          link.classList.add("border-brand-400", "text-brand-300", "font-medium");
        } else {
          link.classList.add("border-transparent");
          link.classList.remove("border-brand-400", "text-brand-300", "font-medium");

          // Restore original text color based on hierarchy
          if (link.classList.contains("pl-8")) { // H3
            link.classList.add("text-slate-500");
          } else { // H2
            link.classList.add("text-slate-400");
          }
        }
      });
    }
  })();
</script>
