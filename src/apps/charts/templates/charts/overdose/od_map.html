<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div id="{{ map_id }}" class="w-full h-[600px]"></div>

<script>
(function() {
    function initMap() {
        if (typeof L === 'undefined') {
            setTimeout(initMap, 50);
            return;
        }

    // Cache buster: {{ timestamp }}
    // Initialize map with authentication-aware zoom behavior
    var isRestricted = {% if zoom_mode == "restricted" %}true{% else %}false{% endif %};

    var mapOptions = {};
    if (isRestricted) {
        mapOptions = {
            // United States-ish bounds: roughly continental US
            maxBounds: L.latLngBounds(
                L.latLng(24.396308, -124.848974), // Southwest (Hawaii/AK excluded on purpose)
                L.latLng(49.384358, -66.885444)   // Northeast
            ),
            minZoom: 4,  // Zoomed out to national view
            maxZoom: 12, // Restricted to city/neighborhood level to protect privacy
        };
    }

    var map = L.map('{{ map_id }}', mapOptions).setView([48.1125, -123.4550], isRestricted ? 8 : 12);

    // Add Esri NatGeo basemap
    L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Â© Esri, National Geographic',
        maxZoom: isRestricted ? 12 : 18
    }).addTo(map);

    // Jurisdictions GeoJSON data
    var jurisdictionsData = {{ jurisdictions_geojson|safe }};

    // OD markers data
    var odMarkersData = {{ od_markers_json|safe }};

    // Style function for jurisdictions
    function style(feature) {
        return {
            fillColor: feature.properties.color,
            weight: 2,
            opacity: 1,
            color: feature.properties.color,
            dashArray: '',
            fillOpacity: 0.15  // Increased for better visibility
        };
    }

    // Highlight feature on hover
    function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
            weight: 3,
            color: layer.feature.properties.color,
            dashArray: '',
            fillOpacity: 0.3
        });

        // Don't call bringToFront() to keep OD markers on top
        // layer.bringToFront();
        info.update({
            type: 'jurisdiction',
            name: layer.feature.properties.name
        });
    }

    // Reset highlight
    function resetHighlight(e) {
        geojson.resetStyle(e.target);
        info.update();
    }

    // Zoom to feature on click
    function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
    }

    // Attach event listeners
    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: zoomToFeature
        });
    }

    // Add jurisdictions layer
    var geojson = L.geoJson(jurisdictionsData, {
        style: style,
        onEachFeature: onEachFeature
    }).addTo(map);

    // Legend control (at top right, added first so it appears on top)
    var legend = L.control({position: 'topright'});

    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend w-60');
        var jurisdictions = [
            {name: 'City of Port Angeles', color: '{{ CITY_COLOR }}'},
            {name: 'Fire District 2', color: '{{ FD2_COLOR }}'},
            {name: 'Fire District 4', color: '{{ FD4_COLOR }}'},
            {name: 'Lower Elwha Reservation', color: '{{ ELWHA_COLOR }}'}
        ];

        div.innerHTML = '<h4 class="m-0 mb-2 text-sm font-semibold">Jurisdictions</h4>';

        jurisdictions.forEach(function(item) {
            div.innerHTML +=
                '<i class="w-4.5 h-4.5 float-left mr-2 opacity-70 border" style="background:' + item.color + '; border-color:' + item.color + ';"></i> ' +
                '<span class="text-xs">' + item.name + '</span><br class="clear-both">';
        });

        return div;
    };

    legend.addTo(map);

    // Custom info control (below legend at top right)
    var info = L.control({position: 'topright'});

    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info w-60 mt-2.5');
        this.update();
        return this._div;
    };

    info.update = function (data) {
        if (!data) {
            // Default state
            this._div.innerHTML = ' <h4 class="m-0 mb-2 text-sm font-semibold">Map Info</h4>' +
                '<span class="text-slate-400 text-xs">Hover over a jurisdiction or overdose marker</span>';
        } else if (data.type === 'jurisdiction') {
            // Jurisdiction info
            this._div.innerHTML = '<h4 class="m-0 mb-2 text-sm font-semibold">Service Area</h4>' +
                '<b class="text-13">' + data.name + '</b>';
        } else if (data.type === 'overdose') {
            // Overdose marker info
            this._div.innerHTML = '<h4 class="m-0 mb-2 text-sm font-semibold">Overdose Location</h4>' +
                '<b class="text-13">Total Cases: ' + data.total_count + '</b><br>' +
                '<b class="text-13">Fatal: ' + data.fatal_count + ' | Non-Fatal: ' + (data.total_count - data.fatal_count) + '</b>';
        }
    };

    info.addTo(map);

    // Create a custom pane for OD markers to ensure they're always on top
    map.createPane('markerPane');
    map.getPane('markerPane').style.zIndex = 650; // Higher than overlays (400) and tooltips (600)

    // Add OD markers to the custom pane
    odMarkersData.forEach(function(marker) {
        var isFatal = marker.fatal_count > 0;
        var color = isFatal ? '#dc2626' : '#f97316';
        var radius = 4 + (marker.total_count * 2);

        var circleMarker = L.circleMarker([marker.lat, marker.lon], {
            radius: radius,
            fillColor: color,
            color: '#fff',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.7,
            pane: 'markerPane', // Use custom pane for proper z-index
            interactive: true // Ensure markers are clickable
        });

        // Add hover events to update info control
        circleMarker.on('mouseover', function(e) {
            info.update({
                type: 'overdose',
                total_count: marker.total_count,
                fatal_count: marker.fatal_count
            });
            // Highlight marker on hover
            this.setStyle({
                weight: 2,
                fillOpacity: 0.9
            });
        });

        circleMarker.on('mouseout', function(e) {
            info.update();
            // Reset marker style
            this.setStyle({
                weight: 1,
                fillOpacity: 0.7
            });
        });

        circleMarker.addTo(map);
    });

    // Add custom CSS for info and legend
    var style = document.createElement('style');
    style.innerHTML = `
        .info {
            padding: 10px 14px;
            font: 12px/1.5 Arial, sans-serif;
            background: {{ info_bg }};
            color: {{ info_color }};
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        .legend {
            padding: 10px 14px;
            font: 12px/1.5 Arial, sans-serif;
            background: {{ legend_bg }};
            color: {{ legend_color }};
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            border: 1px solid rgba(0,0,0,0.2);
            line-height: 24px;
        }
        .legend i {
            border-radius: 3px;
        }
    `;
    document.head.appendChild(style);
    }
    initMap();
})();
</script>
