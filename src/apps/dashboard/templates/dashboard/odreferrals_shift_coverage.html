{% extends "base.html" %}
{% load static %}
{% block pageName %}od-referrals-shift-coverage{% endblock pageName %}
{% block title %}OD Referrals — Shift Coverage{% endblock title %}
{% block page_header %}
{% static 'media/pafd_cpm.jpg' as odreferrals_shift_coverage_header_image %}
{% with eyebrow="OD referral deep dives" title="Shift coverage modeling" description="Model CPM staffing scenarios against overdose timing so teams can cover more cases without adding burnout." image_src=odreferrals_shift_coverage_header_image image_alt="Community paramedics reviewing scheduling coverage maps" image_width="960" image_height="640" updated_at=page_header_updated_at updated_at_iso=page_header_updated_at_iso read_time=page_header_read_time %}
    {% include "partials/page_header.html" %}
{% endwith %}
{% endblock page_header %}
{% block content %}
    <div class="col-span-12 mx-auto w-full">
        <span data-page-name="od-referrals-shift-coverage" class="hidden" hidden></span>
        <div class="w-full pt-20 pb-24 sm:pb-32 space-y-40">

            <!-- Introduction Section -->
            <section class="mx-auto max-w-7xl px-6 lg:px-8">
                <p class="text-base leading-7 text-gray-700 dark:text-slate-300 sm:text-lg">
                    Emergency medical resources are most effective when aligned with <span class="font-semibold text-gray-900 dark:text-white">when and where crises occur</span>. At the Port Angeles Fire Department, operational metrics illuminate a clear truth: <span class="font-semibold text-gray-900 dark:text-white">overdoses do not follow business hours</span>.
                </p>

                <dl class="mt-10 space-y-6">
                    <div class="relative pl-8">
                        <dt class="inline font-semibold text-gray-900 dark:text-white">
                            <div class="absolute left-0 top-1.5 h-2 w-2 rounded-full bg-slate-600 dark:bg-slate-400"></div>
                            The Coverage Gap.
                        </dt>
                        <dd class="inline text-gray-600 dark:text-slate-400"> The traditional 9-to-5 model, while standard for administrative roles, leaves critical gaps in coverage for community paramedicine teams responding to substance use crises.</dd>
                    </div>

                    <div class="relative pl-8">
                        <dt class="inline font-semibold text-gray-900 dark:text-white">
                            <div class="absolute left-0 top-1.5 h-2 w-2 rounded-full bg-slate-600 dark:bg-slate-400"></div>
                            Data-Driven Optimization.
                        </dt>
                        <dd class="inline text-gray-600 dark:text-slate-400"> Our analysis revealed that our 5x8 schedule covered only 23% of incidents. We mapped every incident against our staffing model to identify exactly when our community was most vulnerable.</dd>
                    </div>
                </dl>
            </section>

            <!-- Interactive Scheduling Model -->
            <section class="relative" x-data="shiftScenarioSelector()" x-init="initSelector()">
                <!-- Centered Icon -->
                <div class="absolute left-8 -top-4 flex h-16 w-16 -ml-8 items-center justify-center rounded-full border-4 border-white bg-slate-100 dark:border-slate-900 dark:bg-slate-800 md:left-1/2 md:-ml-8 z-10">
                    <svg class="w-8 h-8 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>

                <div class="space-y-16">
                    <!-- The Narrative Header & Visualizer -->
                    <div class="relative grid grid-cols-1 gap-8 md:grid-cols-2 md:gap-12">
                        <div class="relative pl-16 md:pl-0 md:text-right md:pr-12">
                            <div class="absolute left-8 top-0 bottom-0 w-px bg-slate-200 dark:bg-slate-800 md:left-auto md:-right-6"></div>
                            <div class="sticky top-24">
                                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Modeling Better Coverage</h3>
                                <p class="mt-4 text-lg text-gray-600 dark:text-gray-400">
                                    We didn't just guess at a solution. We rigorously modeled multiple shift patterns against our historical overdose dataset to quantify the potential impact of every schedule change. Select a model below to see how strategic staffing adjustments can close the coverage gap and save more lives.
                                </p>
                            </div>
                        </div>

                        <div class="relative pl-16 md:pl-12">

                            <!-- Coverage Bar Chart -->
                            <div class="rounded-2xl border border-slate-200 bg-white p-8 shadow-sm dark:border-slate-700 dark:bg-slate-800">
                                <h4 class="text-sm font-semibold uppercase tracking-wider text-gray-500">Projected Coverage</h4>

                                <!-- The Bar -->
                                <div class="mt-6 relative h-12 w-full rounded-full bg-slate-100 dark:bg-slate-700 overflow-hidden">
                                    <!-- Base Coverage -->
                                    <div class="absolute left-0 top-0 h-full bg-slate-400 transition-all duration-500 flex items-center justify-center text-xs font-bold text-white"
                                         :style="`width: ${baseCoverage}%`">
                                        <span x-show="baseCoverage > 10">Current</span>
                                    </div>
                                    <!-- Improvement -->
                                    <div class="absolute top-0 h-full bg-indigo-500 transition-all duration-500 flex items-center justify-center text-xs font-bold text-white"
                                         :style="`left: ${baseCoverage}%; width: ${Math.max(0, (scenarios[selectedScenario]?.coverage || 0) - baseCoverage)}%`">
                                        <span x-show="(scenarios[selectedScenario]?.coverage || 0) - baseCoverage > 10">Gain</span>
                                    </div>
                                    <!-- Marker Line for Selected -->
                                    <div class="absolute top-0 bottom-0 w-0.5 bg-black/20 z-10" :style="`left: ${scenarios[selectedScenario]?.coverage || 0}%`"></div>
                                </div>

                                <div class="mt-4 flex justify-between items-end">
                                    <div>
                                        <div class="text-3xl font-bold text-gray-900 dark:text-white" x-text="(scenarios[selectedScenario]?.coverage || 0) + '%'"></div>
                                        <div class="text-sm text-gray-500">Total Coverage</div>
                                    </div>
                                    <div class="text-right" x-show="scenarios[selectedScenario]?.improvement > 0">
                                        <div class="text-xl font-bold text-green-600 dark:text-green-400" x-text="'+' + scenarios[selectedScenario]?.improvement + '%'"></div>
                                        <div class="text-sm text-gray-500">Improvement</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- The Selector Grid -->
                    <div class="pl-16 md:pl-0">
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                            <template x-for="(scenario, key) in scenarios" :key="key">
                                <button class="relative flex flex-col text-left p-6 rounded-xl border-2 transition-all duration-200 bg-white dark:bg-slate-800 hover:shadow-md"
                                        :class="selectedScenario === key ? 'border-indigo-500 ring-1 ring-indigo-500 z-10' : 'border-slate-200 dark:border-slate-700 hover:border-indigo-300 dark:hover:border-indigo-700'"
                                        @click="selectedScenario = key">

                                    <div class="flex justify-between items-start w-full mb-4">
                                        <span class="font-semibold text-gray-900 dark:text-white pr-2" x-text="scenario.name"></span>
                                        <div class="flex-shrink-0 h-6 w-6 rounded-full border border-slate-300 flex items-center justify-center"
                                             :class="selectedScenario === key ? 'bg-indigo-500 border-indigo-500' : ''">
                                            <div class="h-2.5 w-2.5 rounded-full bg-white" x-show="selectedScenario === key"></div>
                                        </div>
                                    </div>

                                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-4 min-h-[2.5em]" x-text="scenario.schedule"></div>

                                    <div class="mt-auto pt-4 border-t border-slate-100 dark:border-slate-700 w-full">
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs font-medium text-slate-500">Coverage</span>
                                            <div class="text-right">
                                                <span x-show="scenario.name === '5x8 (Current)'" class="text-[10px] text-slate-400 font-medium ml-1">(Historic: 23%)</span>
                                                <span class="font-bold" :class="scenario.coverageColor" x-text="scenario.coverage + '%'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </section>
    <!-- Overdose by Time Region - Full Width -->
    <section class="col-span-12">
        <div class="space-y-24">
            <!-- Data Visualization -->
            <div>
                <div class="mb-8">
                    <h2 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-4xl">The Data-Driven Case for Change</h2>
                    <p class="mt-4 text-lg text-gray-600 dark:text-gray-400">Analyzing the coverage gap</p>
                </div>
                <div class="prose prose-lg prose-invert max-w-none mb-8">
                    <p class="text-gray-700 dark:text-gray-300">
                        Our initial analysis revealed a critical disconnect between our operational hours and community needs. While our team worked standard business hours, the crisis was operating on a different clock entirely. We found we were only present for <strong>23%</strong> of incidents. This heatmap visualizes that gap, showing the density of overdose events occurring outside our traditional response window.
                    </p>
                </div>
                <div class="mt-8">
                    <div class="bg-transparent">
                        {% autoescape off %}
                            {{ fig_density_map|safe }}
                        {% endautoescape %}
                    </div>
                </div>
            </div>

            <!-- Temporal Analysis -->
            <div>
                <div class="mb-8">
                    <h3 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-4xl">Pinpointing the Peak</h3>
                </div>
                <div class="prose prose-lg prose-invert max-w-none mb-8">
                    <p class="text-gray-700 dark:text-gray-300">
                        Drilling down into hourly data, a clear and actionable pattern emerged. We identified a significant surge in overdose incidents occurring specifically between <strong>1400 and 1800</strong>—the exact hours where our traditional shift coverage was often winding down or ending. This data point became the cornerstone of our proposal for a staggered shift model.
                    </p>
                </div>
                <div class="mt-8">
                    <div id="fig-container" class="bg-transparent">
                        {% autoescape off %}
                            {{ fig_hourly_breakdown|safe }}
                        {% endautoescape %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- The Human Impact Section -->
    <section class="col-span-12">
        <div class="relative isolate overflow-hidden bg-slate-900 px-6 py-24 sm:py-32 lg:px-8 rounded-3xl">
            <!-- Background effects -->
            <div class="absolute inset-0 -z-10 bg-[radial-gradient(45rem_50rem_at_top,theme(colors.indigo.500),theme(colors.slate.900))] opacity-20"></div>
            <div class="absolute inset-y-0 right-1/2 -z-10 mr-16 w-[200%] origin-bottom-left skew-x-[-30deg] bg-slate-900/80 shadow-xl shadow-indigo-600/10 ring-1 ring-indigo-50/10 sm:mr-28 lg:mr-0 xl:mr-16 xl:origin-center"></div>

            <div class="mx-auto max-w-7xl">
                <div class="grid grid-cols-1 gap-x-16 gap-y-16 lg:grid-cols-2 lg:items-center">
                    <!-- Text Content -->
                    <div class="max-w-2xl">
                        <h2 class="text-3xl font-bold tracking-tight text-white sm:text-4xl mb-6">Why Coverage Matters</h2>
                        <p class="text-lg leading-8 text-gray-300">
                            Our initial findings were dramatic. When we responded to an overdose, patients were far more likely to accept life-saving services because they had an advocate who could stay with them.
                        </p>
                        <p class="mt-4 text-lg leading-8 text-gray-300">
                            The presence of a Community Paramedic transforms a medical emergency into an opportunity for recovery. It's the difference between a cycle of readmission and a path to treatment.
                        </p>
                    </div>

                    <!-- Stats Display -->
                    <div class="grid grid-cols-1 gap-8 sm:grid-cols-2">
                        <!-- Stat 1: Without CPM -->
                        <div class="relative overflow-hidden rounded-2xl bg-white/5 p-8 ring-1 ring-white/10 backdrop-blur-sm transition-all hover:bg-white/10">
                            <dt class="text-sm font-medium leading-6 text-gray-400">Acceptance Rate</dt>
                            <dd class="mt-2 text-xs font-medium text-gray-500 uppercase tracking-wider">Without CPMs</dd>
                            <div class="mt-4 flex items-baseline gap-x-2">
                                <span class="text-5xl font-bold tracking-tight text-white">3%</span>
                            </div>
                            <div class="mt-4 h-1.5 w-full rounded-full bg-white/10">
                                <div class="h-1.5 rounded-full bg-gray-500 w-[3%]"></div>
                            </div>
                            <p class="mt-4 text-sm text-gray-400">Minimal engagement when we aren't on scene.</p>
                        </div>

                        <!-- Stat 2: With CPM -->
                        <div class="relative overflow-hidden rounded-2xl bg-indigo-500/10 p-8 ring-1 ring-indigo-500/50 backdrop-blur-sm transition-all hover:bg-indigo-500/20">
                            <div class="absolute -right-4 -top-4 h-24 w-24 rounded-full bg-indigo-500/20 blur-2xl"></div>
                            <dt class="text-sm font-medium leading-6 text-indigo-200">Acceptance Rate</dt>
                            <dd class="mt-2 text-xs font-bold text-indigo-400 uppercase tracking-wider">With CPMs</dd>
                            <div class="mt-4 flex items-center gap-x-2">
                                <span class="text-5xl font-bold tracking-tight text-white">78%</span>
                                <span class="text-sm text-green-400">↑ 25x Increase</span>
                            </div>
                            <div class="mt-4 h-1.5 w-full rounded-full bg-white/10">
                                <div class="h-1.5 rounded-full bg-indigo-500 w-[78%]"></div>
                            </div>
                            <p class="mt-4 text-sm text-indigo-200">Patients accepting treatment, detox, or aggressive care.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- The Strategic Pivot Section -->
    <section class="col-span-12">
        <div class="mx-auto w-full px-6 lg:px-8">
            <div class="mb-8 flex items-center gap-4">
                <div class="inline-flex items-center rounded-full bg-indigo-50 dark:bg-indigo-500/10 px-3 py-1 text-xs font-medium text-indigo-700 dark:text-indigo-400 ring-1 ring-inset ring-indigo-700/10 dark:ring-indigo-500/20">
                    Strategic Implementation
                </div>
                <div class="h-px flex-1 bg-slate-200 dark:bg-slate-700"></div>
            </div>

            <h2 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white sm:text-4xl mb-8">The 4x10 Solution</h2>

            <div class="space-y-8 text-lg leading-8 text-slate-600 dark:text-slate-300">
                <p class="font-medium">
                    We faced a critical disconnect between our resources and our reality. Our traditional 08:00 to 16:00 schedule was leaving the community vulnerable during the most dangerous hours of the day.
                </p>

                <p>
                    When we analyzed the temporal distribution of overdose calls, a clear pattern emerged: the peak volume wasn't in the morning—it was in the late afternoon. Specifically, the window from <strong class="text-slate-900 dark:text-white font-semibold">14:00 to 18:00</strong> represented the highest density of incidents. Under the old model, our crews were clocking out right in the middle of this surge, leaving a two-hour gap (16:00–18:00) where no community paramedics were available to respond.
                </p>

                <div class="my-12 border-l-4 border-indigo-500 pl-8 py-4">
                    <h4 class="text-sm font-bold uppercase tracking-wider text-indigo-600 dark:text-indigo-400 mb-2">The Critical Gap</h4>
                    <p class="text-2xl font-bold text-slate-900 dark:text-white italic">
                        "We're going home exactly when this population needs us the most."
                    </p>
                </div>

                <p>
                    The solution wasn't to hire more staff, but to rethink how we deployed the staff we had. By transitioning to a <strong class="text-slate-900 dark:text-white font-semibold">4x10 schedule</strong>, we could extend our daily operational hours without increasing headcount.
                </p>
                <p>
                    This shift added those crucial two hours to every shift, ensuring that a Community Paramedic is on duty and ready to respond throughout the entire 14:00–18:00 peak window. It’s a simple adjustment with profound implications: by aligning our availability with the data, we turn missed opportunities into saved lives.
                </p>
            </div>
        </div>
    </section>
    </div>

    <script>
        function scenarioData() {
            return {
                scenarios: {},

                initScenarios() {
                    try {
                        const scenarioElement = document.getElementById('scenarios-data');
                        if (scenarioElement) {
                            this.scenarios = JSON.parse(scenarioElement.textContent);
                        }
                    } catch (error) {
                        console.error('Error parsing scenario data:', error);
                        this.scenarios = {};
                    }
                }
            }
        }

        function shiftScenarioSelector() {
            return {
                selectedScenario: '5x8 (Current)',
                scenarios: {},
                baseCoverage: 0,

                initSelector() {
                    // Load scenarios from backend data
                    try {
                        const scenarioElement = document.getElementById('scenarios-data');
                        if (scenarioElement) {
                            const backendData = JSON.parse(scenarioElement.textContent);

                            // Transform backend data to frontend format
                            this.scenarios = {};

                            // Filter out restricted scenarios for color scale calculation
                            const validScenarios = Object.entries(backendData).filter(([key, data]) =>
                                !key.includes('3×14') && !key.includes('3×12')
                            );
                            const coverageValues = validScenarios.map(([key, data]) => data.coverage);
                            const minCoverage = Math.min(...coverageValues);
                            const maxCoverage = Math.max(...coverageValues);

                            // Find base coverage
                            this.baseCoverage = backendData['5x8 (Current)']?.coverage || 0;

                            for (const [key, data] of Object.entries(backendData)) {
                                this.scenarios[key] = {
                                    name: key,
                                    schedule: data.description,
                                    coverage: Math.round(data.coverage),
                                    cases_covered: Math.round(data.cases_per_year),
                                    improvement: key === '5x8 (Current)' ? 0 : Math.round(((data.coverage - backendData['5x8 (Current)']?.coverage || 0) / (backendData['5x8 (Current)']?.coverage || 1)) * 100),
                                    benefits: this.getBenefitsForScenario(key, data),
                                    coverageColor: this.getCoverageColor(data.coverage, minCoverage, maxCoverage, key)
                                };
                            }

                            // Set default selection
                            this.selectedScenario = '5x8 (Current)';
                        }
                    } catch (error) {
                        console.error('Error loading scenario data:', error);
                        // Fallback to hardcoded current scenario
                        this.scenarios = {
                            '5x8 (Current)': {
                                name: '5x8 (Current)',
                                schedule: 'Single Crew: Mon-Fri 08:00-16:00',
                                coverage: {{ current_coverage|default:23 }},
                                cases_covered: 43,
                                improvement: 0,
                                benefits: ['Traditional business hours', 'Covers baseline cases', 'Established routine'],
                                coverageColor: 'text-red-600 dark:text-red-400'
                            }
                        };
                        this.baseCoverage = {{ current_coverage|default:23 }};
                        this.selectedScenario = '5x8 (Current)';
                    }
                },

                getCoverageColor(coverage, minCoverage, maxCoverage, scenarioName) {
                    // Check if this is a legally restricted scenario
                    if (scenarioName && scenarioName.includes('3×12')) {
                        return 'text-gray-500 dark:text-gray-500';  // Gray out legally restricted scenarios
                    }

                    // For valid scenarios, create a relative color scale from lowest to highest performance
                    const range = maxCoverage - minCoverage;
                    const normalizedPosition = range > 0 ? (coverage - minCoverage) / range : 0;

                    if (normalizedPosition <= 0.2) {
                        return 'text-red-600 dark:text-red-400';           // Lowest 20%
                    } else if (normalizedPosition <= 0.4) {
                        return 'text-orange-600 dark:text-orange-400';     // 20-40%
                    } else if (normalizedPosition <= 0.6) {
                        return 'text-amber-600 dark:text-amber-400';       // 40-60%
                    } else if (normalizedPosition <= 0.8) {
                        return 'text-yellow-600 dark:text-yellow-400';     // 60-80%
                    } else {
                        return 'text-green-600 dark:text-green-400';       // Top 20%
                    }
                },

                getBenefitsForScenario(name, data) {
                    const benefits = [];

                    if (name === '5x8 (Current)') {
                        return ['Traditional business hours', 'Covers baseline cases', 'Established routine'];
                    }

                    // Add note for legally restricted scenarios
                    if (name.includes('3×12')) {
                        benefits.push('⚠️ Not legally compliant - Reference only');
                    }

                    if (data.coverage > 60) benefits.push('High coverage percentage');
                    if (name.includes('Weekend')) benefits.push('Weekend coverage included');
                    if (name.includes('Staggered')) benefits.push('Overlapping crew coverage');
                    if (name.includes('3×12')) benefits.push('Balanced work schedule');
                    if (name.includes('4×10')) benefits.push('Optimized weekly schedule');
                    if (data.hours_per_week <= 80) benefits.push('Efficient resource usage');

                    return benefits.length > 0 ? benefits : ['Improved coverage strategy'];
                }
            }
        }
    </script>
</div>
    <!-- Hidden data elements for JavaScript -->
    <script type="application/json" id="scenarios-data">{{ scenarios_data|safe }}</script>
    <style>
        .delay-1000 {
            animation-delay: 1s !important;
        }
        .delay-500 {
            animation-delay: 0.5s !important;
        }
        .delay-2000 {
            animation-delay: 2s !important;
        }
        .bg-key-insights-image {
            background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
        }
        /* SVG gradient stops for insight-gradient */
        .insight-stop-0 {
            stop-color: #fbbf24;
            stop-opacity: 1;
        }
        .insight-stop-50 {
            stop-color: #f59e0b;
            stop-opacity: 1;
        }
        .insight-stop-100 {
            stop-color: #d97706;
            stop-opacity: 1;
        }
    </style>
{% endblock content %}
