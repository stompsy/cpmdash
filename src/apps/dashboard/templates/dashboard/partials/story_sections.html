{% if story_sections %}
<div class="mt-12 w-full max-w-7xl mx-auto">
    <div class="space-y-12 lg:space-y-16">
        {% for section in story_sections %}
            {% with step=section.sequence|default:forloop.counter %}
                <article class="group relative">
                    {# Step indicator with connecting line #}
                    <div class="flex gap-6 sm:gap-8">
                        {# Left column: Step badge and connector #}
                        <div class="relative flex flex-col items-center">
                            {# Step number badge #}
                            <div class="relative z-10 flex h-14 w-14 shrink-0 items-center justify-center rounded-2xl border-2 border-indigo-500/20 bg-gradient-to-br from-indigo-50 to-white shadow-lg shadow-indigo-500/10 transition-all duration-300 group-hover:scale-110 group-hover:border-indigo-500/40 group-hover:shadow-indigo-500/20 dark:border-indigo-400/30 dark:from-slate-800 dark:to-slate-900 dark:shadow-indigo-400/10">
                                <span class="text-xl font-bold text-indigo-600 dark:text-indigo-400">{{ step }}</span>
                            </div>
                            {# Connecting line (hidden on last item) #}
                            {% if not forloop.last %}
                                <div class="mt-2 h-full w-0.5 bg-gradient-to-b from-indigo-200 via-indigo-100 to-transparent dark:from-indigo-900/50 dark:via-indigo-900/30 dark:to-transparent"></div>
                            {% endif %}
                        </div>

                        {# Right column: Content card #}
                        <div class="flex-1 pb-4">
                            <div class="rounded-3xl border border-slate-200/80 bg-white shadow-xl shadow-slate-200/50 transition-all duration-300 hover:shadow-2xl hover:shadow-slate-300/60 dark:border-slate-700/60 dark:bg-gradient-to-br dark:from-slate-900/95 dark:to-slate-800/95 dark:shadow-slate-900/50 dark:hover:shadow-slate-900/80">
                                {# Header section #}
                                <div class="border-b border-slate-200/60 px-8 py-6 dark:border-slate-700/50">
                                    <div class="flex items-center gap-3">
                                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-indigo-100 dark:bg-indigo-500/20">
                                            {% if step == 1 %}
                                                <svg class="h-5 w-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                                            {% elif step == 2 %}
                                                <svg class="h-5 w-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                            {% else %}
                                                <svg class="h-5 w-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                            {% endif %}
                                        </div>
                                        <h2 class="text-2xl font-bold tracking-tight text-gray-900 dark:text-white">{{ section.title }}</h2>
                                    </div>
                                    {% if section.lede %}
                                        <p class="mt-4 text-base leading-7 text-gray-700 dark:text-slate-300">{{ section.lede }}</p>
                                    {% endif %}
                                </div>

                                {# Main content: metrics and actions side by side #}
                                <div class="p-8">
                                    <div class="grid gap-8 lg:grid-cols-3">
                                        {# Metrics grid - takes 2 columns on large screens #}
                                        {% if section.metrics %}
                                            <div class="lg:col-span-2">
                                                <h3 class="mb-4 text-xs font-semibold uppercase tracking-widest text-gray-500 dark:text-slate-400">Key metrics</h3>
                                                <div class="grid gap-4 sm:grid-cols-2">
                                                    {% for metric in section.metrics %}
                                                        <div class="group/metric relative overflow-hidden rounded-xl border border-slate-200/80 bg-gradient-to-br from-slate-50 to-white p-5 transition-all duration-200 hover:border-indigo-300 hover:shadow-lg dark:border-slate-700/60 dark:from-slate-800/50 dark:to-slate-900/30 dark:hover:border-indigo-500/50">
                                                            <div class="absolute -right-6 -top-6 h-24 w-24 rounded-full bg-indigo-500/5 transition-all duration-300 group-hover/metric:scale-150 dark:bg-indigo-400/5"></div>
                                                            <p class="relative text-[10px] font-bold uppercase tracking-[0.15em] text-gray-500 dark:text-slate-400">{{ metric.label }}</p>
                                                            <p class="relative mt-2 text-3xl font-bold text-gray-900 dark:text-white">{{ metric.value }}</p>
                                                            {% if metric.description %}
                                                                <p class="relative mt-2 text-xs leading-5 text-gray-600 dark:text-slate-400">{{ metric.description }}</p>
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}

                                        {# Actions sidebar #}
                                        <div class="lg:col-span-1">
                                            {% if section.actions %}
                                                <div class="sticky top-8">
                                                    <h3 class="mb-4 text-xs font-semibold uppercase tracking-widest text-gray-500 dark:text-slate-400">Action items</h3>
                                                    <ul class="space-y-3">
                                                        {% for action in section.actions %}
                                                            <li class="group/action flex items-start gap-3 rounded-lg bg-slate-50/50 p-3 text-sm leading-6 text-gray-700 transition-all duration-200 hover:bg-indigo-50/50 dark:bg-slate-800/30 dark:text-slate-300 dark:hover:bg-indigo-900/20">
                                                                <span class="mt-1.5 inline-flex h-1.5 w-1.5 shrink-0 rounded-full bg-indigo-500 ring-4 ring-indigo-100 transition-all duration-200 group-hover/action:ring-indigo-200 dark:bg-indigo-400 dark:ring-indigo-900/50 dark:group-hover/action:ring-indigo-800/50"></span>
                                                                <span>{{ action }}</span>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                {# Footer: Related charts #}
                                {% if section.related_charts %}
                                    <div class="border-t border-slate-200/60 bg-slate-50/50 px-8 py-4 dark:border-slate-700/50 dark:bg-slate-800/30">
                                        <div class="flex items-center gap-2 text-xs">
                                            <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                                            <span class="font-semibold uppercase tracking-wider text-gray-500 dark:text-slate-400">Related:</span>
                                            <span class="text-gray-600 dark:text-slate-400">{{ section.related_charts|join:", " }}</span>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </article>
            {% endwith %}
        {% endfor %}
    </div>
</div>
{% endif %}
