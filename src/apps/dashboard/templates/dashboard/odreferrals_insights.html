{% extends "base.html" %}
{% load static %}

{% block pageName %}od-referrals-insights{% endblock pageName %}
{% block title %}Overdose Referrals â€” Insights{% endblock title %}

{% block content %}
<!-- Hero / Intro -->
<section class="col-span-12 mb-16">
    <div class="relative isolate overflow-hidden bg-white dark:bg-gray-900 px-6 sm:px-12 md:px-20 py-20 rounded-2xl shadow-md lg:overflow-visible">
       <div class="absolute inset-0 -z-20 bg-center bg-cover bg-no-repeat rounded-2xl"
           style="background-image: url('{% static 'media/pafd_cpm.jpg' %}'); filter: contrast(1.2) brightness(0.85) saturate(1.08);"></div>
        <div class="absolute inset-0 -z-10 bg-slate-900/80 rounded-2xl"></div>
        <div class="relative z-10 mx-auto text-white max-w-4xl">
            <p class="text-sm font-semibold uppercase tracking-wider text-indigo-300">Overdose Referral Ops</p>
            <h1 class="mt-3 text-4xl font-semibold tracking-tight text-pretty sm:text-5xl">
                Overdose Referral Insights
            </h1>
            <p class="mt-6 text-lg sm:text-xl text-indigo-100/90">
                Trace who submits overdose referrals, how CPM teams respond, and where naloxone and SUD handoffs are happening. Use these insights to strengthen partner alerts, align shift coverage, and accelerate post-overdose outreach.
            </p>
        </div>
    </div>
</section>

{% if data_is_empty %}
<section class="col-span-12">
    <div class="rounded-2xl bg-white dark:bg-gray-900 p-12 shadow-md text-center text-gray-700 dark:text-gray-300">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">No overdose referrals captured yet</h2>
        <p class="mt-4 max-w-2xl mx-auto">
            Import overdose referral records (including suspected substance, referral source, engagement location, and CPM disposition fields) to unlock automated insights. Once data flows in, this page will spotlight top referring agencies, substance trends, and housing contexts that shape outreach strategy.
        </p>
    </div>
</section>
{% else %}
<!-- Summary cards -->
<section class="col-span-12 mb-12 mx-auto px-6 sm:px-12 md:px-20">
    <div class="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-5">
        {% for card in summary_cards %}
            <article class="group relative overflow-hidden rounded-2xl bg-white dark:bg-gray-900 p-6 shadow-md ring-1 ring-gray-200/80 dark:ring-white/10">
                <div class="flex items-center justify-between">
                    <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600 dark:text-indigo-400">{{ card.label }}</p>
                    <span class="rounded-full bg-indigo-50 dark:bg-indigo-500/20 p-2 text-indigo-500 dark:text-indigo-200">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 3.75h15M4.5 3.75v14.5A1.75 1.75 0 0 0 6.25 20h11.5A1.75 1.75 0 0 0 19.5 18.25V3.75" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.75v-1a2.25 2.25 0 0 1 4.5 0v1" />
                        </svg>
                    </span>
                </div>
                <p class="mt-5 text-3xl font-semibold text-gray-900 dark:text-white">{{ card.value }}</p>
                <p class="mt-3 text-sm text-gray-600 dark:text-gray-400">{{ card.description }}</p>
            </article>
        {% endfor %}
    </div>
</section>

<!-- Top agencies table -->
<section class="col-span-12 mb-12 mx-auto px-6 sm:px-12 md:px-20">
    <div class="rounded-2xl bg-white dark:bg-gray-900 shadow-md ring-1 ring-gray-200/80 dark:ring-white/10">
        <div class="border-b border-gray-200 dark:border-white/10 px-6 py-6 sm:px-10 sm:py-8">
            <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600 dark:text-indigo-400">Partner engagement</p>
                    <h2 class="mt-2 text-2xl font-semibold text-gray-900 dark:text-white">Top overdose referral agencies</h2>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400 max-w-3xl">
                        Agencies contributing the most overdose referrals, along with naloxone usage, SUD handoffs, and unique individuals touched. Highlight strong partners and lift up agencies that may need additional support.
                    </p>
                </div>
                <div class="flex items-center gap-2 rounded-full bg-indigo-50 dark:bg-indigo-500/20 px-4 py-2 text-sm font-medium text-indigo-600 dark:text-indigo-200">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75 9 12l3 3 7.5-7.5" />
                    </svg>
                    Collaboration Leaders
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            {% if top_agencies %}
            <table class="min-w-full divide-y divide-gray-200 dark:divide-white/5 text-left">
                <thead class="bg-gray-50/80 dark:bg-white/5 text-xs uppercase tracking-wide text-gray-600 dark:text-gray-300">
                    <tr>
                        <th scope="col" class="px-6 py-3">Agency</th>
                        <th scope="col" class="px-6 py-3">Referrals</th>
                        <th scope="col" class="px-6 py-3">Share %</th>
                        <th scope="col" class="px-6 py-3">Unique patients</th>
                        <th scope="col" class="px-6 py-3">Narcan events</th>
                        <th scope="col" class="px-6 py-3">Narcan %</th>
                        <th scope="col" class="px-6 py-3">SUD handoffs</th>
                        <th scope="col" class="px-6 py-3">SUD %</th>
                        <th scope="col" class="px-6 py-3">Fatal / CPR</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200/70 dark:divide-white/5 text-sm text-gray-700 dark:text-gray-200">
                    {% for row in top_agencies %}
                    <tr class="hover:bg-indigo-50/40 dark:hover:bg-indigo-500/10">
                        <td class="px-6 py-3 font-medium text-gray-900 dark:text-white">{{ row.agency }}</td>
                        <td class="px-6 py-3">{{ row.referrals }}</td>
                        <td class="px-6 py-3">{{ row.share_pct|floatformat:1 }}%</td>
                        <td class="px-6 py-3">{{ row.unique_patients }}</td>
                        <td class="px-6 py-3">{{ row.narcan_events }}</td>
                        <td class="px-6 py-3">{{ row.narcan_pct|floatformat:1 }}%</td>
                        <td class="px-6 py-3">{{ row.sud_referrals }}</td>
                        <td class="px-6 py-3">{{ row.sud_pct|floatformat:1 }}%</td>
                        <td class="px-6 py-3">{{ row.fatal_events }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="px-6 py-12 text-center text-sm text-gray-600 dark:text-gray-300">
                No referring agencies recorded yet. Add referral agency data to surface partner performance.
            </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Substance and engagement patterns -->
<section class="col-span-12 mb-12 mx-auto px-6 sm:px-12 md:px-20">
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <article class="rounded-2xl bg-white dark:bg-gray-900 shadow-md ring-1 ring-gray-200/80 dark:ring-white/10">
            <header class="border-b border-gray-200 dark:border-white/10 px-6 py-6">
                <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600 dark:text-indigo-400">Substance mix</p>
                <h3 class="mt-2 text-xl font-semibold text-gray-900 dark:text-white">Leading suspected substances</h3>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Top suspected substances across overdose referrals, with naloxone and SUD referral follow-through.</p>
            </header>
            <div class="overflow-x-auto">
                {% if suspected_drugs %}
                <table class="min-w-full divide-y divide-gray-200 dark:divide-white/5 text-left">
                    <thead class="bg-gray-50/80 dark:bg-white/5 text-xs uppercase tracking-wide text-gray-600 dark:text-gray-300">
                        <tr>
                            <th scope="col" class="px-6 py-3">Substance</th>
                            <th scope="col" class="px-6 py-3">Referrals</th>
                            <th scope="col" class="px-6 py-3">Share %</th>
                            <th scope="col" class="px-6 py-3">Narcan %</th>
                            <th scope="col" class="px-6 py-3">SUD %</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200/70 dark:divide-white/5 text-sm text-gray-700 dark:text-gray-200">
                        {% for row in suspected_drugs %}
                        <tr class="hover:bg-indigo-50/40 dark:hover:bg-indigo-500/10">
                            <td class="px-6 py-3 font-medium text-gray-900 dark:text-white">{{ row.label }}</td>
                            <td class="px-6 py-3">{{ row.referrals }}</td>
                            <td class="px-6 py-3">{{ row.share_pct|floatformat:1 }}%</td>
                            <td class="px-6 py-3">{{ row.narcan_pct|floatformat:1 }}%</td>
                            <td class="px-6 py-3">{{ row.sud_pct|floatformat:1 }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="px-6 py-12 text-center text-sm text-gray-600 dark:text-gray-300">
                    No suspected substance data documented yet.
                </div>
                {% endif %}
            </div>
        </article>
        <article class="rounded-2xl bg-white dark:bg-gray-900 shadow-md ring-1 ring-gray-200/80 dark:ring-white/10">
            <header class="border-b border-gray-200 dark:border-white/10 px-6 py-6">
                <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600 dark:text-indigo-400">Engagement geography</p>
                <h3 class="mt-2 text-xl font-semibold text-gray-900 dark:text-white">Where CPM meets clients</h3>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Locations that host the most CPM engagements following an overdose referral.</p>
            </header>
            <div class="overflow-x-auto">
                {% if engagement_locations %}
                <table class="min-w-full divide-y divide-gray-200 dark:divide-white/5 text-left">
                    <thead class="bg-gray-50/80 dark:bg-white/5 text-xs uppercase tracking-wide text-gray-600 dark:text-gray-300">
                        <tr>
                            <th scope="col" class="px-6 py-3">Location</th>
                            <th scope="col" class="px-6 py-3">Referrals</th>
                            <th scope="col" class="px-6 py-3">Share %</th>
                            <th scope="col" class="px-6 py-3">Narcan %</th>
                            <th scope="col" class="px-6 py-3">SUD %</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200/70 dark:divide-white/5 text-sm text-gray-700 dark:text-gray-200">
                        {% for row in engagement_locations %}
                        <tr class="hover:bg-indigo-50/40 dark:hover:bg-indigo-500/10">
                            <td class="px-6 py-3 font-medium text-gray-900 dark:text-white">{{ row.label }}</td>
                            <td class="px-6 py-3">{{ row.referrals }}</td>
                            <td class="px-6 py-3">{{ row.share_pct|floatformat:1 }}%</td>
                            <td class="px-6 py-3">{{ row.narcan_pct|floatformat:1 }}%</td>
                            <td class="px-6 py-3">{{ row.sud_pct|floatformat:1 }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="px-6 py-12 text-center text-sm text-gray-600 dark:text-gray-300">
                    No engagement location data recorded yet.
                </div>
                {% endif %}
            </div>
        </article>
    </div>
</section>

<!-- Referral pathways and living context -->
<section class="col-span-12 mb-12 mx-auto px-6 sm:px-12 md:px-20">
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <article class="rounded-2xl bg-white dark:bg-gray-900 shadow-md ring-1 ring-gray-200/80 dark:ring-white/10">
            <header class="border-b border-gray-200 dark:border-white/10 px-6 py-6">
                <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600 dark:text-indigo-400">Alert channels</p>
                <h3 class="mt-2 text-xl font-semibold text-gray-900 dark:text-white">Where overdose referrals originate</h3>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Referral sources contributing alerts into CPM, with follow-through indicators.</p>
            </header>
            <div class="overflow-x-auto">
                {% if referral_sources %}
                <table class="min-w-full divide-y divide-gray-200 dark:divide-white/5 text-left">
                    <thead class="bg-gray-50/80 dark:bg-white/5 text-xs uppercase tracking-wide text-gray-600 dark:text-gray-300">
                        <tr>
                            <th scope="col" class="px-6 py-3">Source</th>
                            <th scope="col" class="px-6 py-3">Referrals</th>
                            <th scope="col" class="px-6 py-3">Share %</th>
                            <th scope="col" class="px-6 py-3">Narcan %</th>
                            <th scope="col" class="px-6 py-3">SUD %</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200/70 dark:divide-white/5 text-sm text-gray-700 dark:text-gray-200">
                        {% for row in referral_sources %}
                        <tr class="hover:bg-indigo-50/40 dark:hover:bg-indigo-500/10">
                            <td class="px-6 py-3 font-medium text-gray-900 dark:text-white">{{ row.label }}</td>
                            <td class="px-6 py-3">{{ row.referrals }}</td>
                            <td class="px-6 py-3">{{ row.share_pct|floatformat:1 }}%</td>
                            <td class="px-6 py-3">{{ row.narcan_pct|floatformat:1 }}%</td>
                            <td class="px-6 py-3">{{ row.sud_pct|floatformat:1 }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="px-6 py-12 text-center text-sm text-gray-600 dark:text-gray-300">
                    No referral source information captured yet.
                </div>
                {% endif %}
            </div>
        </article>
        <article class="rounded-2xl bg-white dark:bg-gray-900 shadow-md ring-1 ring-gray-200/80 dark:ring-white/10">
            <header class="border-b border-gray-200 dark:border-white/10 px-6 py-6">
                <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600 dark:text-indigo-400">Living context</p>
                <h3 class="mt-2 text-xl font-semibold text-gray-900 dark:text-white">Housing situations documented</h3>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Living situations tied to overdose referrals help guide outreach, shelter partnerships, and follow-up safety planning.</p>
            </header>
            <div class="overflow-x-auto">
                {% if living_situations %}
                <table class="min-w-full divide-y divide-gray-200 dark:divide-white/5 text-left">
                    <thead class="bg-gray-50/80 dark:bg-white/5 text-xs uppercase tracking-wide text-gray-600 dark:text-gray-300">
                        <tr>
                            <th scope="col" class="px-6 py-3">Living situation</th>
                            <th scope="col" class="px-6 py-3">Referrals</th>
                            <th scope="col" class="px-6 py-3">Share %</th>
                            <th scope="col" class="px-6 py-3">Narcan %</th>
                            <th scope="col" class="px-6 py-3">SUD %</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200/70 dark:divide-white/5 text-sm text-gray-700 dark:text-gray-200">
                        {% for row in living_situations %}
                        <tr class="hover:bg-indigo-50/40 dark:hover:bg-indigo-500/10">
                            <td class="px-6 py-3 font-medium text-gray-900 dark:text-white">{{ row.label }}</td>
                            <td class="px-6 py-3">{{ row.referrals }}</td>
                            <td class="px-6 py-3">{{ row.share_pct|floatformat:1 }}%</td>
                            <td class="px-6 py-3">{{ row.narcan_pct|floatformat:1 }}%</td>
                            <td class="px-6 py-3">{{ row.sud_pct|floatformat:1 }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="px-6 py-12 text-center text-sm text-gray-600 dark:text-gray-300">
                    No housing context documented yet.
                </div>
                {% endif %}
            </div>
        </article>
    </div>
</section>

<!-- Key takeaways -->
{% if takeaways %}
<section class="col-span-12 mb-12 mx-auto px-6 sm:px-12 md:px-20">
    <div class="rounded-2xl bg-indigo-50/60 dark:bg-indigo-500/10 p-8 shadow-md ring-1 ring-indigo-100/80 dark:ring-indigo-500/30">
        <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600 dark:text-indigo-200">Highlights</p>
        <h3 class="mt-2 text-2xl font-semibold text-gray-900 dark:text-white">Quick takeaways</h3>
        <ul class="mt-6 space-y-3 text-sm text-gray-700 dark:text-gray-200">
            {% for insight in takeaways %}
            <li class="flex gap-3">
                <span class="mt-1 h-1.5 w-1.5 rounded-full bg-indigo-500"></span>
                <span>{{ insight }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
</section>
{% endif %}
{% endif %}
{% endblock content %}
