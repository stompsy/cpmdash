{% extends "base.html" %}
{% load static %}
{% block pageName %}od-referrals-hotspots{% endblock pageName %}
{% block title %}OD Referrals â€” Hotspots Map{% endblock title %}
{% block page_header %}
{% static 'media/pafd_cpm.jpg' as odreferrals_hotspots_header_image %}
{% with eyebrow="OD referral deep dives" title="Overdose hotspot intelligence" description="Surface overdoses by location so CPM teams can prioritize outreach, align harm-reduction partners, and plan proactive deployments." image_src=odreferrals_hotspots_header_image image_alt="Community paramedics reviewing a neighborhood hotspot map" image_width="960" image_height="640" updated_at=page_header_updated_at updated_at_iso=page_header_updated_at_iso read_time=page_header_read_time %}
    {% include "partials/page_header.html" %}
{% endwith %}
{% endblock page_header %}
{% block content %}
    <div class="col-span-12 mx-auto mt-16 w-full max-w-7xl">
        <span data-page-name="od-referrals-hotspots" class="hidden" hidden></span>
        <div class="space-y-16">
            <section class="col-span-12">
        <div class="relative isolate overflow-hidden bg-white dark:bg-gray-900 px-2 sm:px-4 lg:px-12 py-20 rounded-3xl">
            <div class="absolute inset-0 -z-10">
                <svg class="absolute -top-24 right-10 w-80 h-80 opacity-10 dark:opacity-5" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                    <radialGradient id="hotspot-radial" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" stop-color="#ef4444" stop-opacity="0.8" />
                        <stop offset="60%" stop-color="#f59e0b" stop-opacity="0.4" />
                        <stop offset="100%" stop-color="#3b82f6" stop-opacity="0.2" />
                    </radialGradient>
                    </defs>
                    <circle cx="200" cy="200" r="180" fill="url(#hotspot-radial)" />
                </svg>
            </div>
            <div class="mx-auto max-w-6xl space-y-16">
                <div class="grid gap-12 lg:grid-cols-5 items-start">
                    <div class="lg:col-span-3">
                        <p class="text-sm font-semibold uppercase tracking-widest text-indigo-600 dark:text-indigo-400">Post Overdose Response Team (PORT)</p>
                        <h2 class="mt-4 text-4xl font-semibold tracking-tight text-gray-900 dark:text-white sm:text-5xl">Overdose Hotspots</h2>
                        <p class="mt-6 text-lg text-gray-700 dark:text-gray-300">
                            15.6 months of overdose responses highlight the neighborhoods where Community Paramedicine teams intersect with the highest risk. This standalone map combines geospatial clustering with outcome markers to help prioritize outreach, naloxone distribution, and partner engagement.
                        </p>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="grid grid-cols-2 gap-4 lg:grid-cols-1">
                            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 p-6 text-center shadow-sm">
                                <p class="text-sm uppercase tracking-wide text-gray-500 dark:text-gray-400">Mapped overdoses</p>
                                <p class="mt-2 text-3xl font-semibold text-gray-900 dark:text-white">{{ hotspot_stats.total }}</p>
                            </div>
                            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 p-6 text-center shadow-sm">
                                <p class="text-sm uppercase tracking-wide text-gray-500 dark:text-gray-400">Fatal share</p>
                                <p class="mt-2 text-3xl font-semibold text-gray-900 dark:text-white">{{ hotspot_stats.fatal_pct }}<span class="text-base">%</span></p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ hotspot_stats.fatal_count }} cases</p>
                            </div>
                            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 p-6 text-center shadow-sm">
                                <p class="text-sm uppercase tracking-wide text-gray-500 dark:text-gray-400">Unique locations</p>
                                <p class="mt-2 text-3xl font-semibold text-gray-900 dark:text-white">{{ hotspot_stats.unique_locations }}</p>
                            </div>
                            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 p-6 text-center shadow-sm">
                                <p class="text-sm uppercase tracking-wide text-gray-500 dark:text-gray-400">Weekend activity</p>
                                <p class="mt-2 text-3xl font-semibold text-gray-900 dark:text-white">{{ hotspot_stats.weekend_pct }}<span class="text-base">%</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="rounded-3xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-md overflow-hidden">
                    {% if hotspot_stats.total %}
                        <div class="p-6 lg:p-8 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Interactive Hotspot Map</h2>
                                <p class="mt-3 text-sm text-gray-600 dark:text-gray-300 max-w-3xl">
                                    Bubble radius scales with case density while color differentiates fatal outcomes. Use the map controls to zoom, drag, and isolate priority corridors for focused engagement.
                                </p>
                            </div>
                            <span class="inline-flex items-center gap-2 text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400">
                                <svg class="w-3 h-3 text-rose-500" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path d="M10 2a6 6 0 0 0-6 6c0 4.122 4.252 9.036 5.624 10.576a.5.5 0 0 0 .752 0C11.748 17.036 16 12.122 16 8a6 6 0 0 0-6-6Zm0 8.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z" /></svg>
                                Drag to explore
                            </span>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-700">
                            {% autoescape off %}
                                {{ fig_od_map|safe }}
                            {% endautoescape %}
                        </div>
                    {% else %}
                        <div class="p-12 text-center text-gray-600 dark:text-gray-300">
                            <p class="text-lg font-medium">No geocoded overdose referrals available.</p>
                            <p class="mt-2 text-sm">Add latitude and longitude to OD referrals to unlock hotspot analysis.</p>
                        </div>
                    {% endif %}
                </div>

                {% if hotspot_stats.total %}
                    <div class="grid gap-8 lg:grid-cols-3">
                        <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                            <p class="text-sm font-semibold text-gray-900 dark:text-white">Top location share</p>
                            <p class="mt-3 text-3xl font-semibold text-gray-900 dark:text-white">{{ hotspot_stats.top_location_share }}<span class="text-base">%</span></p>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ hotspot_stats.top_location_count }} cases from a single address.</p>
                        </div>
                        <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm lg:col-span-2">
                            <p class="text-sm font-semibold text-gray-900 dark:text-white">Field deployment tip</p>
                            <p class="mt-3 text-sm text-gray-700 dark:text-gray-300">Pair the hotspot map with shift coverage findings to schedule teams when high-density corridors align with weekend demand.</p>
                        </div>
                        {% if hotspot_insights %}
                            <div class="lg:col-span-3 grid gap-6 md:grid-cols-2">
                                {% for insight in hotspot_insights %}
                                    <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-800/80 p-6 shadow-sm">
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ insight.title }}</h3>
                                        <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">{{ insight.body }}</p>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% elif hotspot_insights %}
                    <div class="grid gap-6 md:grid-cols-2">
                        {% for insight in hotspot_insights %}
                            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-800/80 p-6 shadow-sm">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ insight.title }}</h3>
                                <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">{{ insight.body }}</p>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
            </section>
            {% if document_metrics %}
            <section class="col-span-12">
                <div class="bg-white dark:bg-gray-900 px-2 sm:px-4 lg:px-12 pb-16">
                    <div class="mx-auto max-w-6xl space-y-8">
                    <div class="flex flex-col gap-3 lg:flex-row lg:items-end lg:justify-between">
                        <div>
                            <p class="text-sm font-semibold uppercase tracking-widest text-indigo-600 dark:text-indigo-400">Documented field context</p>
                            <h2 class="text-3xl font-semibold tracking-tight text-gray-900 dark:text-white">PORT performance from narrative reports</h2>
                        </div>
                        <p class="max-w-xl text-sm text-gray-600 dark:text-gray-300">Key overdose outcomes summarized from quarterly reports and grant narratives. Use these metrics to weight hotspot clusters with proven follow-up strategies.</p>
                    </div>
                    <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
                        {% for metric in document_metrics %}
                            <article class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm flex flex-col gap-4">
                                <header class="space-y-3">
                                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">{{ metric.title }}</p>
                                    <span class="text-3xl font-semibold text-gray-900 dark:text-white">{{ metric.stat }}</span>
                                    {% if metric.detail %}
                                        <p class="text-sm text-gray-700 dark:text-gray-300">{{ metric.detail }}</p>
                                    {% endif %}
                                </header>
                                {% if metric.map_tip %}
                                    <p class="text-sm text-gray-700 dark:text-gray-300">{{ metric.map_tip }}</p>
                                {% endif %}
                                <footer class="mt-auto text-xs text-gray-500 dark:text-gray-400">
                                    Source: {{ metric.source }}
                                </footer>
                            </article>
                        {% endfor %}
                    </div>
                    </div>
                </div>
            </section>
            {% endif %}
        </div>
    </div>
{% endblock content %}
