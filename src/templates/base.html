{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
        />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        {# Basic SEO Meta (override via blocks) #}
        {% block meta_description %}<meta name="description" content="Community public health monitoring & overdose response dashboard." />{% endblock meta_description %}
        {% block meta_keywords %}<meta name="keywords" content="public health, overdose, dashboard, analytics" />{% endblock meta_keywords %}
        {% block meta_author %}<meta name="author" content="{{ request.site.name|default:'CPM Dash' }}" />{% endblock meta_author %}
        {% block meta_robots %}<meta name="robots" content="index,follow" />{% endblock meta_robots %}
        <meta name="referrer" content="strict-origin-when-cross-origin" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)" />
        <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />

        <title>{% block title %} {% endblock title %}</title>
        <link rel="shortcut icon" type="image/png" href="{% static 'media/favicon.ico' %}"/>
        <link rel="stylesheet" href="{% static 'css/output.css' %}" />
        <style>[x-cloak] { display: none !important; }</style>
        <script defer src="{% static 'js/htmx.min.js' %}"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script src="https://d3js.org/d3.v7.min.js"></script>
    </head>
    <body
        x-data="{
            page: '{% block pageName %}{% endblock pageName %}',
            'loaded': true,
            'darkMode': true,
            'stickyMenu': false,
            'sidebarToggle': false,
            'scrollTop': false,
            'isProfileInfoModal': false,
            'isProfileAddressModal': false,

            'disclaimerCookieName': 'cpmdash_beta_disclaimer_accepted',
            'disclaimerOpen': false,
            'cookieNoticeOpen': false,

            getCookieValue(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            },
            setCookie(name, value, days = 365) {
                const maxAge = days * 24 * 60 * 60;
                const secure = (window.location && window.location.protocol === 'https:') ? '; Secure' : '';
                document.cookie = `${name}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; SameSite=Lax${secure}`;
            },
            initDisclaimer() {
                const accepted = this.getCookieValue(this.disclaimerCookieName) === '1';
                this.disclaimerOpen = !accepted;
            },
            acceptDisclaimer() {
                this.setCookie(this.disclaimerCookieName, '1');
                this.disclaimerOpen = false;
                this.cookieNoticeOpen = true;
            }
        }"
        x-init="
            darkMode = true;
            localStorage.setItem('darkMode', JSON.stringify(true));
            $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)));
            initDisclaimer();"
        :class="{'dark bg-gray-900': darkMode === true}"
    >
        <!-- ===== Preloader Start ===== -->
        {% include "partials/preloader.html" %}
        <!-- ===== Preloader End ===== -->

        <!-- ===== Page Wrapper Start ===== -->
        <div class="flex h-screen overflow-hidden">
            <!-- ===== Sidebar Start ===== -->
            {% include "partials/sidebar.html" %}
            <!-- ===== Sidebar End ===== -->

            <!-- ===== Content Area Start ===== -->
            <div
                id="main-content-scroll-area"
                class="relative flex flex-col flex-1 overflow-x-hidden overflow-y-auto"
            >
                <!-- Small Device Overlay Start -->
                {% include "partials/overlay.html" %}
                <!-- Small Device Overlay End -->

                <!-- ===== Header Start ===== -->
                {% include "partials/header.html" %}
                <!-- ===== Header End ===== -->

                <!-- Toasts: sticky overlay in content area -->
                {% if messages %}
                <div class="sticky top-24 z-[100000] flex w-full justify-center pointer-events-none h-0 overflow-visible">
                    <div class="flex w-full max-w-sm flex-col gap-3 pointer-events-auto px-4 sm:px-0">
                        {% for message in messages %}
                        <div
                            x-data="{
                                open: true,
                                timer: null,
                                scheduleHide(delay = 6000) {
                                    if (this.timer) clearTimeout(this.timer);
                                    this.timer = setTimeout(() => this.open = false, delay);
                                }
                            }"
                            x-init="scheduleHide()"
                            x-show="open"
                            x-transition.opacity.duration.250ms
                            @mouseenter="if (timer) clearTimeout(timer)"
                            @mouseleave="scheduleHide(3000)"
                            role="alert"
                            aria-live="assertive"
                            class="relative flex items-start gap-3 rounded-2xl border border-white/10 bg-white/5 px-5 py-3 text-sm text-slate-100 shadow-xl backdrop-blur {% if 'error' in message.tags %}!border-rose-500/50 !bg-rose-500/15 !text-rose-100{% elif 'success' in message.tags %}!border-emerald-400/40 !bg-emerald-400/15 !text-emerald-100{% endif %}"
                        >
                            <span class="flex-1 leading-relaxed">{{ message }}</span>
                            <button
                                type="button"
                                class="shrink-0 rounded-full p-1 text-slate-200/70 transition hover:bg-white/10 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900"
                                @click="open = false"
                                aria-label="Dismiss notification"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 0 1 1.414 0L10 8.586l4.293-4.293a1 1 0 0 1 1.414 1.414L11.414 10l4.293 4.293a1 1 0 0 1-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L8.586 10 4.293 5.707a1 1 0 0 1 0-1.414Z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- ===== Main Content Start ===== -->
                <main id="dashboard-main">
                    {% block page_header %}{% endblock page_header %}
                    <div class="mx-auto w-full max-w-7xl space-y-8">
                        <div class="grid grid-cols-12 gap-6 px-6">
                            {% block content %}{% endblock content %}
                        </div>
                    </div>

                    <!-- ===== Footer Start ===== -->
                    {% include "partials/footer.html" %}
                    <!-- ===== Footer End ===== -->
                </main>
                <!-- ===== Main Content End ===== -->
            </div>
            <!-- ===== Content Area End ===== -->
        </div>
        <!-- ===== Page Wrapper End ===== -->

        <!-- BEGIN MODAL -->
        {% include "partials/profile/profile-info-modal.html" %}
        {% include "partials/profile/profile-address-modal.html" %}
        <!-- END MODAL -->

        <!-- BEGIN BETA DISCLAIMER MODAL -->
        <div
            x-cloak
            x-show="disclaimerOpen"
            class="fixed inset-0 z-[200000] flex items-center justify-center p-6"
            role="dialog"
            aria-modal="true"
            aria-label="Beta release disclaimer"
        >
            <div class="absolute inset-0 bg-slate-950/60 backdrop-blur-sm"></div>
            <div class="relative w-full max-w-xl overflow-hidden rounded-3xl border border-white/10 bg-slate-900/80 p-8 shadow-2xl ring-1 ring-black/40 backdrop-blur">
                <div class="mb-4 inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs font-semibold uppercase tracking-wider text-slate-200">
                    Beta Release
                </div>
                <h2 class="text-2xl font-bold tracking-tight text-white">Data accuracy disclaimer</h2>
                <p class="mt-4 text-sm leading-relaxed text-slate-300">
                    This dashboard is a beta release. While the data is intended to be as accurate as possible, it may contain mistakes.
                    By accepting, you acknowledge this limitation and agree to proceed.
                </p>

                <div class="mt-8 flex items-center justify-end">
                    <button
                        type="button"
                        class="inline-flex items-center justify-center rounded-md bg-sky-500 px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-400 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-500"
                        @click="acceptDisclaimer()"
                    >
                        I accept
                    </button>
                </div>
            </div>
        </div>
        <!-- END BETA DISCLAIMER MODAL -->

        <!-- BEGIN COOKIE NOTICE (bottom-right) -->
        <div
            x-cloak
            x-show="cookieNoticeOpen"
            x-transition.opacity.duration.200ms
            class="fixed bottom-4 right-4 z-[190000] w-full max-w-sm px-4 sm:px-0"
            role="status"
            aria-live="polite"
        >
            <div class="relative rounded-2xl border border-white/10 bg-slate-900/80 px-5 py-4 text-sm text-slate-100 shadow-xl backdrop-blur">
                <div class="flex items-start gap-3">
                    <div class="mt-0.5 shrink-0" aria-hidden="true">
                        <svg viewBox="0 0 24 24" class="h-7 w-7">
                            <circle cx="12" cy="12" r="9" class="text-amber-300" fill="currentColor" />
                            <circle cx="9" cy="10" r="1" class="text-slate-900/60" fill="currentColor" />
                            <circle cx="14" cy="9" r="1.2" class="text-slate-900/60" fill="currentColor" />
                            <circle cx="15.5" cy="13" r="0.9" class="text-slate-900/60" fill="currentColor" />
                            <circle cx="10.5" cy="14.5" r="1.1" class="text-slate-900/60" fill="currentColor" />
                        </svg>
                    </div>
                    <div class="flex-1 leading-relaxed text-slate-200">
                        This site uses a cookie to remember that you accepted the beta disclaimer.
                    </div>
                    <button
                        type="button"
                        class="shrink-0 rounded-full p-1 text-slate-200/70 transition hover:bg-white/10 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900"
                        @click="cookieNoticeOpen = false"
                        aria-label="Dismiss cookie notice"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 0 1 1.414 0L10 8.586l4.293-4.293a1 1 0 0 1 1.414 1.414L11.414 10l4.293 4.293a1 1 0 0 1-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L8.586 10 4.293 5.707a1 1 0 0 1 0-1.414Z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- END COOKIE NOTICE -->

        <script>
            // Ensure HTMX requests include CSRF token
            (function() {
                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                }
                if (document.body) {
                    document.body.addEventListener('htmx:configRequest', function(evt) {
                        const token = getCookie('csrftoken');
                        if (token) {
                            evt.detail.headers['X-CSRFToken'] = token;
                        }
                    });

                    document.body.addEventListener('htmx:afterSwap', function(evt) {
                        const target = evt.target;
                        if (!target || target.id !== 'dashboard-main') {
                            return;
                        }
                        const pageSource = target.getAttribute('data-page');
                        const marker = target.querySelector('[data-page-name]');
                        const pageName = pageSource || (marker ? marker.getAttribute('data-page-name') : null);
                        if (pageName && document.body.__x && document.body.__x.$data) {
                            document.body.__x.$data.page = pageName;
                        }
                    });

                    // Scroll to top on navigation
                    document.body.addEventListener('htmx:afterSwap', function(evt) {
                        // Only scroll for main content navigation, not for inline updates
                        if (evt.target && evt.target.id === 'dashboard-main') {
                            // Find the scrollable content area
                            const contentArea = document.getElementById('main-content-scroll-area');
                            if (contentArea) {
                                contentArea.scrollTo({ top: 0, behavior: 'instant' });
                            }
                        }
                    });

                    document.body.addEventListener('htmx:historyRestore', function() {
                        const target = document.querySelector('#dashboard-main');
                        if (!target) {
                            return;
                        }
                        const marker = target.querySelector('[data-page-name]');
                        const pageName = marker ? marker.getAttribute('data-page-name') : null;
                        if (pageName && document.body.__x && document.body.__x.$data) {
                            document.body.__x.$data.page = pageName;
                        }
                    });
                }
            })();
        </script>
    </body>
</html>
