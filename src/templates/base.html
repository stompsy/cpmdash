{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
        />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        {# Basic SEO Meta (override via blocks) #}
        {% block meta_description %}<meta name="description" content="Community public health monitoring & overdose response dashboard." />{% endblock meta_description %}
        {% block meta_keywords %}<meta name="keywords" content="public health, overdose, dashboard, analytics" />{% endblock meta_keywords %}
        {% block meta_author %}<meta name="author" content="{{ request.site.name|default:'CPM Dash' }}" />{% endblock meta_author %}
        {% block meta_robots %}<meta name="robots" content="index,follow" />{% endblock meta_robots %}
        <meta name="referrer" content="strict-origin-when-cross-origin" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)" />
        <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />

        <title>{% block title %} {% endblock title %}</title>
        <link rel="shortcut icon" type="image/png" href="{% static 'media/favicon.ico' %}"/>
        <link rel="stylesheet" href="{% static 'css/output.css' %}" />
        <script defer src="{% static 'js/htmx.min.js' %}"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    </head>
    <body
        x-data="{
            page: '{% block pageName %}{% endblock pageName %}',
            'loaded': true,
            'darkMode': true,
            'stickyMenu': false,
            'sidebarToggle': false,
            'scrollTop': false,
            'isProfileInfoModal': false,
            'isProfileAddressModal': false
        }"
        x-init="
            darkMode = true;
            localStorage.setItem('darkMode', JSON.stringify(true));
            $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
        :class="{'dark bg-gray-900': darkMode === true}"
    >
        <!-- ===== Preloader Start ===== -->
        {% include "partials/preloader.html" %}
        <!-- ===== Preloader End ===== -->

        <!-- ===== Page Wrapper Start ===== -->
        <div class="flex h-screen overflow-hidden">
            <!-- ===== Sidebar Start ===== -->
            {% include "partials/sidebar.html" %}
            <!-- ===== Sidebar End ===== -->

            <!-- ===== Content Area Start ===== -->
            <div
                class="relative flex flex-col flex-1 overflow-x-hidden overflow-y-auto"
            >
                <!-- Small Device Overlay Start -->
                {% include "partials/overlay.html" %}
                <!-- Small Device Overlay End -->

                <!-- ===== Header Start ===== -->
                {% include "partials/header.html" %}
                <!-- ===== Header End ===== -->

                <!-- ===== Main Content Start ===== -->
                <main>
                    <div
                        id="dashboard-main"
                        class="mx-auto w-full px-6 py-10 space-y-12 sm:px-10"
                    >
                        {% block page_header %}{% endblock page_header %}
                        <div class="grid grid-cols-12 gap-6">
                            {% block content %}{% endblock content %}
                        </div>
                    </div>

                    <!-- ===== Footer Start ===== -->
                    {% include "partials/footer.html" %}
                    <!-- ===== Footer End ===== -->
                </main>
                <!-- ===== Main Content End ===== -->
            </div>
            <!-- ===== Content Area End ===== -->
        </div>
        <!-- ===== Page Wrapper End ===== -->

        <!-- Toasts: fixed overlay -->
        {% if messages %}
        <div class="pointer-events-none fixed top-4 right-4 z-[100] flex max-h-[calc(100vh-2rem)] w-full max-w-sm flex-col gap-3 overflow-y-auto">
            {% for message in messages %}
            <div
                x-data="{
                    open: true,
                    timer: null,
                    scheduleHide(delay = 6000) {
                        if (this.timer) clearTimeout(this.timer);
                        this.timer = setTimeout(() => this.open = false, delay);
                    }
                }"
                x-init="scheduleHide()"
                x-show="open"
                x-transition.opacity.duration.250ms
                @mouseenter="if (timer) clearTimeout(timer)"
                @mouseleave="scheduleHide(3000)"
                role="alert"
                aria-live="assertive"
                class="pointer-events-auto relative flex items-start gap-3 rounded-2xl border border-white/10 bg-white/5 px-5 py-3 text-sm text-slate-100 shadow-xl backdrop-blur {% if 'error' in message.tags %}!border-rose-500/50 !bg-rose-500/15 !text-rose-100{% elif 'success' in message.tags %}!border-emerald-400/40 !bg-emerald-400/15 !text-emerald-100{% endif %}"
            >
                <span class="flex-1 leading-relaxed">{{ message }}</span>
                <button
                    type="button"
                    class="shrink-0 rounded-full p-1 text-slate-200/70 transition hover:bg-white/10 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900"
                    @click="open = false"
                    aria-label="Dismiss notification"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 0 1 1.414 0L10 8.586l4.293-4.293a1 1 0 0 1 1.414 1.414L11.414 10l4.293 4.293a1 1 0 0 1-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L8.586 10 4.293 5.707a1 1 0 0 1 0-1.414Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- BEGIN MODAL -->
        {% include "partials/profile/profile-info-modal.html" %}
        {% include "partials/profile/profile-address-modal.html" %}
        <!-- END MODAL -->

        <script>
            // Ensure HTMX requests include CSRF token
            (function() {
                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                }
                if (document.body) {
                    document.body.addEventListener('htmx:configRequest', function(evt) {
                        const token = getCookie('csrftoken');
                        if (token) {
                            evt.detail.headers['X-CSRFToken'] = token;
                        }
                    });

                    document.body.addEventListener('htmx:afterSwap', function(evt) {
                        const target = evt.target;
                        if (!target || target.id !== 'dashboard-main') {
                            return;
                        }
                        const pageSource = target.getAttribute('data-page');
                        const marker = target.querySelector('[data-page-name]');
                        const pageName = pageSource || (marker ? marker.getAttribute('data-page-name') : null);
                        if (pageName && document.body.__x && document.body.__x.$data) {
                            document.body.__x.$data.page = pageName;
                        }
                    });

                    document.body.addEventListener('htmx:historyRestore', function() {
                        const target = document.querySelector('#dashboard-main');
                        if (!target) {
                            return;
                        }
                        const marker = target.querySelector('[data-page-name]');
                        const pageName = marker ? marker.getAttribute('data-page-name') : null;
                        if (pageName && document.body.__x && document.body.__x.$data) {
                            document.body.__x.$data.page = pageName;
                        }
                    });
                }
            })();
        </script>
    </body>
</html>
